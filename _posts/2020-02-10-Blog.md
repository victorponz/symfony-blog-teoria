---

typora-copy-images-to: ../assets/img/blog/
typora-root-url: ../../
layout: post
categories: parte5
conToc: true
permalink: blog
title: Blog
---

## 5 Qué aprenderemos

* A crear atributos de tipo `Date` que almacenen la fecha actual

* A usar un slugger

* A obtener el usuario registrado en controladores y plantillas

* A formatear fechas en twig

  

## 5.1 Entidad

En esta parte vamos a centrarnos en el blog. Seremos capaces de:

* Crear entradas
* Listar entradas
* Dar a *me gusta*
* Dejar comentarios

El primer paso va a ser crear la entidad `Post`

<script id="asciicast-IIiyVr0WwNyfv0moOwrYhdcSP" src="https://asciinema.org/a/IIiyVr0WwNyfv0moOwrYhdcSP.js" async></script>

El atributo `Date` va a almacenar la fecha actual por lo que hemos de modificar el constructor de la entidad `Post`

```php
public function __construct()
{
    $this->PublishedAt = new \DateTime();
}
```

Y realizar la migración:

```
php bin/console make:migration
php bin/console doctrine:migrations:migrate
```

## 5.2 Formulario

El siguiente paso va a ser crear la ruta `/post/new/` para que podemos escribir las entradas de blog. En esta ruta mostraremos el formulario que creamos a continuación:

```
php bin/console make:Form PostFormType Post
```

Vamos a eliminar algunos atributos porque los vamos a informar a mano:

```php
public function buildForm(FormBuilderInterface $builder, array $options): void
{
    $builder
        ->add('Title')
        ->add('Content')
        ->add('Image')
    ;
}
```

Y creamos el controlador:

```php
/**
 * @Route("/blog/new", name="new_post")
 */
public function newPost(ManagerRegistry $doctrine, Request $request, SluggerInterface $slugger): Response
{
    $post = new Post();
    $form = $this->createForm(PostFormType::class, $post);
    $form->handleRequest($request);
    if ($form->isSubmitted() && $form->isValid()) {
        $post = $form->getData();   
        $post->setSlug($slugger->slug($post->getTitle()));
        $post->setUser($this->getUser());
        $post->setNumLikes(0);
        $post->setNumComments(0);
        $entityManager = $doctrine->getManager();    
        $entityManager->persist($post);
        $entityManager->flush();
        return $this->render('blog/new_post.html.twig', array(
            'form' => $form->createView()    
        ));
    }
    return $this->render('blog/new_post.html.twig', array(
        'form' => $form->createView()    
    ));
}
```

Y la plantilla:

{% raw %}

```twig
{% extends 'base.html.twig' %}
{% block title%}Images{% endblock %}
{% block body%}
<!-- Principal Content Start -->
   <div id="new Post">
   	  <div class="container">
   	    <div class="col-xs-12 col-sm-8 col-sm-push-2">
       	   <h1>New Post</h1>
			   {{ form(form, {'attr': {'class':'form-horizontal'}}) }}
       	   <hr class="divider">
		</div>   
   	  </div>
   </div>
<!-- Principal Content Start -->
{% endblock %}
```

{% endraw %}

Comprobamos que podemos almacenar una entrada de Post:

![image-20220328085401615](/symfony-blog-teoria/assets/img/blog/image-20220328085401615.png)

![image-20220328085505136](/symfony-blog-teoria/assets/img/blog/image-20220328085505136.png)

## 5.3 RETO

Ya solo nos queda:

* Crear un campo de tipo `file` para la imagen
* Añadir las clases css a los campos del formulario
* Hacer que los campos `Title`, `Content` e `Image` sean obligatorios
* Comprobar si el usuario ha iniciado sesión para reenviarlo a `login`
* Reenviar al usuario a la ruta `/blog` 

![image-20220328091514301](/symfony-blog-teoria/assets/img/blog/image-20220328091514301.png)

## 5.4 Ruta `single_post`

Ahora ya podemos renderizar el contenido de un post. Primero modificamos la ruta `single_post` para que acepte un parámetro en la ruta. Por ejemplo `single_post/mi-primera-entrada-de-blog`

```php
/**
 * @Route("/single_post/{slug}", name="single_post")
 */
public function post($slug): Response
{
    return $this->render('blog/single_post.html.twig', [
        'controller_name' => 'BlogController',
    ]);
}
```

Y ahora modificamos el controlador para redirigir a esta ruta:

```php
return $this->redirectToRoute('single_post', ["slug" => $post->getSlug()]);
```

Ya solo nos queda modificar el controlador:

```php
/**
 * @Route("/single_post/{slug}", name="single_post")
 */
public function post(ManagerRegistry $doctrine, $slug): Response
{
    $repositorio = $doctrine->getRepository(Post::class);
    $post = $repositorio->findOneBy(["Slug"=>$slug]);
    return $this->render('blog/single_post.html.twig', [
        'post' => $post,
    ]);
}
```

Y la plantilla en la que usaremos una instrucción condicional para mostrar un texto si no se ha encontrado la entrada de blog:

{% raw %}

```twig
{% if not post %}
<h2>Post not found</h2>
{% else %}
resto de plantilla
{% endif %}
```

{% endraw %}

Usaremos los siguientes datos en la plantilla

{% raw %}

```twig
{{post.title}}
{{asset('images/blog/' ~ post.image) }}
{{post.content}}
{{post.user.name}}
{{post.publishedAt | date('d') }} {{ post.publishedAt | date('F') }}
```

{% endraw %}

## 5.5 Lista de posts recientes

Vamos a crear la lista con los últimos 5 posts 

![image-20220328094912201](/symfony-blog-teoria/assets/img/blog/image-20220328094912201.png)

Modificamos el controlador para que obtenga los 5 post más recientes para lo que hemos de crear un método en el repositorio:

```php

/**
* @return Post[] Returns an array of Post objects
*/
public function findRecents()
{
    return $this->createQueryBuilder('p')
        ->orderBy('p.publishedAt', 'DESC')
        ->setMaxResults(5)
        ->getQuery()
        ->getResult()
    ;
}
```

El controlador:

```php
/**
 * @Route("/single_post/{slug}", name="single_post")
 */
public function post(ManagerRegistry $doctrine, $slug): Response
{
    $repositorio = $doctrine->getRepository(Post::class);
    $post = $repositorio->findOneBy(["Slug"=>$slug]);
    $recents = $repositorio->findRecents();
    return $this->render('blog/single_post.html.twig', [
        'post' => $post,
        'recents' => $recents
    ]);
}
```

Y modificamos la plantilla, creando primero un partial para cada una de las entradas de blog

Partial `recent_post.html.twig`:

{% raw %}

```twig
 <div>
    <hr>
        <a href="{{ path('single_post', {'slug':recent.slug}) }}">{{ recent.title }}</a>
        <h5> By <span>{{ recent.user.name }}</span></h5>
        <p>{{ post.publishedAt | date('d') }} {{ post.publishedAt | date('F') }}</p><i class="fa fa-clock-o sr-icons"></i> 
         {{ post.publishedAt | date('h') }} 
         {{ post.publishedAt | date('A') }}
</div>
```
{% endraw %}

Y por último la plantilla `single_post.html.twig`

{% raw %}

```twig
{% for recent in recents %}
{{ include ('partials/recent_post.html.twig', {'recent': recent}) }}
{% endfor %}
```

{% endraw %}

## 5.6 Comentarios

Vamos a implementar la funcionalidad para enviar comentarios a los mensajes. No implementaremos la opción de poner estrellas.

Crearemos una entidad llamada `Comment`:

<script id="asciicast-7sew07d7FKPyktuiJI4Kvzh3P" src="https://asciinema.org/a/7sew07d7FKPyktuiJI4Kvzh3P.js" async></script>

Y hacemos la migración:

```
php bin/console make:migration
php bin/console doctrine:migrations:migrate
```

Un formulario;

```
php bin/console make:Form CommentFormType Comment
```
{% raw %}

```php
public function buildForm(FormBuilderInterface $builder, array $options): void
{
    $builder
        ->add('name',  null, ['attr' => ['class'=>'form-control']])
        ->add('email', EmailType::class, ['attr' => ['class'=>'form-control']])
        ->add('text',  null, ['label' => 'Type Your Comment', 'attr' => ['class'=>'form-control']])
        ->add('Send', SubmitType::class, array('label' => 'Send', 'attr' => ['class'=>'pull-right btn btn-lg sr-button']));
    ;
}
```

Plantilla:

```twig
<div id="form" class="col-xs-12 col-sm-6 col-sm-push-3">
{{ form(commentForm, {'attr': {'class':'form-horizontal'}}) }}
</div>
</form>
```
Modificamos la plantilla `single_post` para incluir el formulario:

```twig
 {{ include ('partials/form_comment.html.twig') }}
```

{% endraw %}

Y, por último, el controlador;

```php
/**
 * @Route("/single_post/{slug}", name="single_post")
 */
public function post(ManagerRegistry $doctrine, Request $request, $slug): Response
{
    $repositorio = $doctrine->getRepository(Post::class);
    $post = $repositorio->findOneBy(["Slug"=>$slug]);
    $recents = $repositorio->findRecents();
    $comment = new Comment();
    $form = $this->createForm(CommentFormType::class, $comment);
    $form->handleRequest($request);
    if ($form->isSubmitted() && $form->isValid()) {
        $comment = $form->getData();   
        $entityManager = $doctrine->getManager();    
        $entityManager->persist($comment);
        $entityManager->flush();
    }
    return $this->render('blog/single_post.html.twig', [
        'post' => $post,
        'recents' => $recents,
        'commentForm' => $form->createView()
    ]);
}
```

Y en la entidad hacemos que la fecha de publicación se informe automáticamente:

```php
public function __construct()
{
    $this->publishedAt = new \DateTime();
}
```

### 5.6.1 RETO: Lista de comentarios

Ahora ya podemos crear la lista de comentarios

Igual que hemos hecho con las lista de posts recientes, crearemos un partial y modificamos la plantilla para recorrer los comentarios.

![image-20220329184705441](/symfony-blog-teoria/assets/img/blog/image-20220329184705441.png)