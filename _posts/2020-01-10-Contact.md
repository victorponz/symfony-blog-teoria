---

typora-copy-images-to: ../assets/img/contact/
typora-root-url: ../../
layout: post
categories: parte2
---

## 2.0 ¿Qué aprenderemos?

* A conectar con una base de datos
* A generar un formulario
* A guardar los datos del formulario en la base de datos
* A usar mensajes *flash*

## 2.1 Formulario

En esta parte del curso vamos a crear el formulario para que se puedan enviar mensajes.

![image-20220316120736757](/symfony-blog-teoria/assets/img/contact/image-20220316120736757.png)

### 2.1.1 Conexión con la base de datos

Para crear la base de datos, hemos de modificar el archivo `.env` introduciendo la url apropiada. En el caso de MySql es la siguiente

```
DATABASE_URL="mysql://db_user:db_password@127.0.0.1:3306/blog?serverVersion=5.7&charset=utf8mb4"
```

Sustituyendo `db_user` y  `db_password` por los valores apropiados y `blog` es el nombre de la base de datos. Para crearla se usa el comando:

```
php bin/console doctrine:database:create
```

### 2.1.2 Creación de la entidad `Mensaje`

El primer paso para trabajar con la Base de Datos es definir la entidad en la que debemos almacenar los datos. En principio, una entidad equivale a una tabla en la base de datos. Para crearla usamos el siguiente comando:

```
php bin/console make:entity
```
Nos pedirá los nombres y atributos de los campos de la entidad:

<script id="asciicast-9j2uAV2nkCoeJoYWc4kFCEIgG" src="https://asciinema.org/a/9j2uAV2nkCoeJoYWc4kFCEIgG.js" async></script>

Ahora ya sólo nos queda crear la tabla asociada en la base de datos mediante los siguientes comandos

```
php bin/console doctrine:migrations:migrate
```

Este comando crea un archivo en el directorio `migrations` con el siguiente contenido:

```php
<?php

declare(strict_types=1);

namespace DoctrineMigrations;

use Doctrine\DBAL\Schema\Schema;
use Doctrine\Migrations\AbstractMigration;

/**
 * Auto-generated Migration: Please modify to your needs!
 */
final class Version20220316114610 extends AbstractMigration
{
    public function getDescription(): string
    {
        return '';
    }

    public function up(Schema $schema): void
    {
        // this up() migration is auto-generated, please modify it to your needs
        $this->addSql('CREATE TABLE contact (id INT AUTO_INCREMENT NOT NULL, first_name VARCHAR(255) NOT NULL, last_name VARCHAR(255) NOT NULL, email VARCHAR(255) NOT NULL, subject LONGTEXT NOT NULL, PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8mb4 COLLATE `utf8mb4_unicode_ci` ENGINE = InnoDB');
    }

    public function down(Schema $schema): void
    {
        // this down() migration is auto-generated, please modify it to your needs
        $this->addSql('DROP TABLE contact');
    }
}

```

En el que se ve el comando SQL que va a ejecutar al realizar la migración.

Y por último aplicar la migración:

```
php bin/console make:migration
```

#### 2.1.2.1 Clase `Contact`

Al ejecutar el comando `php bin/console make:entity` Symfony ha creados dos archivos. Uno llamado `App\Entity\Contact.php` que almacena la definición de la entidad y otro llamado `App\Repository\ContactRepository.php` que es la clase encargada de realizar las tareas relacionadas con la entidad `Contact`. Esta clase que hereda de `ServiceEntityRepository` tiene los siguientes métodos para obtener registros de la base de datos (que veremos aplicados más adelante)

- El método `find` localiza el objeto por la clave primaria (normalmente el id) que se le pasa como parámetro.  Así buscaríamos el contacto con id 1:

  ```php
  $contact = $repositorio->find(1);
  ```

- El método `findOneBy` localiza un  objeto que cumpla los criterios de búsqueda pasados como parámetro. Así  buscaríamos el contacto cuyo teléfono sea “900110011”:

  ```php
  $contact = $repositorio->findOneBy(["email" => "email@ejemplo.com"]);
  ```

  En el caso de querer definir más criterios de búsqueda, se pasarían uno tras otro en el array, separados por comas.

- El método `findBy` localiza todos los  objetos que cumplan los criterios de búsqueda pasados como parámetro.  Esta instrucción es como la anterior, pero devuelve un array de  contactos con todos los resultados coincidentes:

  ```php
  $contacts = $repositorio->findBy(["email" => "email@ejemplo.com"]);
  ```

- El método `findAll` (sin parámetros), obtiene todos los objetos de la colección.

  ```php
  $contacts = $repositorio->findAll();
  ```



